name: Release Intuis Connect

on:
  push:
    branches:
      - develop
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

jobs:
  # Release for develop branch (auto-creates beta tags)
  release-beta:
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version & compute tag
        id: vars
        run: |
          VERSION=$(jq -r .version custom_components/intuis_connect/manifest.json)
          TAG="v${VERSION}-beta"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create/move beta tag
        run: |
          git tag -f "${{ steps.vars.outputs.tag }}" "$GITHUB_SHA"
          git push origin "${{ steps.vars.outputs.tag }}" --force

      - name: Build integration ZIP
        run: |
          TAG=${{ steps.vars.outputs.tag }}
          cd custom_components/intuis_connect
          zip -r ../../intuis_connect_${TAG}.zip ./*
          cd -

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: Intuis Connect ${{ steps.vars.outputs.tag }}
          draft: false
          prerelease: true
          files: intuis_connect_${{ steps.vars.outputs.tag }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Release for main (triggered by manual tag push)
  release-stable:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag name
        id: vars
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Build integration ZIP
        run: |
          TAG=${{ steps.vars.outputs.tag }}
          cd custom_components/intuis_connect
          zip -r ../../intuis_connect_${TAG}.zip ./*
          cd -

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: Intuis Connect ${{ steps.vars.outputs.tag }}
          draft: false
          prerelease: false
          files: intuis_connect_${{ steps.vars.outputs.tag }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
